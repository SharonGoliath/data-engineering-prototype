import os

from cadc_operators import ToCaom2Operator, PreviewOperator

from airflow.models import DAG
from airflow import configuration as conf
from airflow import utils

LOG_FORMAT = conf.get('core', 'LOG_FORMAT')
DEFAULT_LOGGING_CONFIG = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'airflow': {
            'format': LOG_FORMAT
        },
    },
    'root': {
        'handlers': ['console'],
        'level': 'INFO'
    }
}

args = {
    'owner': 'airflow',
    'start_date': utils.dates.days_ago(2)
}

# TODO set a schedule
dag = DAG(
    dag_id='cadc_omm2caom2', default_args=args,
    schedule_interval=None, catchup=False)

root_dir = '/root/airflow'
netrc = os.path.join(root_dir, '.netrc')

# TODO make this into a database query, or a tap query (? don't know how
# it's supposed to be implemented) - in any case, this is the list of
# files that's the input, and this bit of code is the logic that makes
# a list of files into a collection of observation, plane, and artifact
# identifiers
# for obs_id in ('C050808_0249A_SCI', 'C060630_0452_SCI', 'C071128_0740_FOCUS',
#                'C071112_0001_CAL', 'C080920_0194_SCI', 'C090620_0003_SCI',
#                'C100925_0342_CAL', 'C110114_0133_SCI', 'C120311_0700_SCI',
#                'C170324_0028_FOCUS', 'C120902_sh2-132_J_old_SCIRED',
#                'C170323_0172_CAL', 'C170217_0228_SCI',
#                'C170323_domeflat_K_CALRED', 'C170318_0002_FOCUS',
#                'C170324_0054_SCI', 'C170318_0121_SCI'):
# work_fqn = os.path.join(root_dir, 'todo.txt')
# with open(work_fqn) as f:
#     for line in f:
#         obs_id = line.strip()
for obs_id in ('C110605_0527_SCI',
               'C110117_0007_FOCUS',
               'C110117_0237_SCI',
               'C110117_0009_FOCUS',
               'C110117_0100_SCI',
               'C110117_0650_CAL',
               'C110117_0469_SCI',
               'C110117_0467_SCI',
               'C110117_0425_SCI',
               'C110117_0516_SCI',
               'C110117_0514_SCI',
               'C110117_0148_SCI',
               'C110117_0053_SCI',
               'C110117_0377_SCI',
               'C110117_0098_SCI',
               'C110117_0470_SCI',
               'C110117_0604_CAL',
               'C110117_0652_CAL',
               'C110117_0605_CAL',
               'C110124_0289_SCI',
               'C110117_0005_FOCUS',
               'C110117_0513_SCI',
               'C110117_0147_SCI',
               'C110117_0517_SCI',
               'C110117_0052_SCI',
               'C110124_0195_SCI',
               'C110117_0426_SCI',
               'C110124_0431_SCI',
               'C110117_0238_SCI',
               'C110117_0558_CAL',
               'C110117_0006_FOCUS',
               'C110117_0559_CAL',
               'C110117_0150_SCI',
               'C110117_0192_SCI',
               'C110124_0060_SCI',
               'C110124_0103_SCI',
               'C110117_0239_SCI',
               'C110117_0144_SCI',
               'C110117_0241_SCI',
               'C110117_0283_SCI',
               'C110117_0655_SCI',
               'C110117_0380_SCI',
               'C110117_0651_CAL',
               'C110124_0152_SCI',
               'C110117_0606_CAL',
               'C110117_0471_SCI',
               'C110124_0336_SCI',
               'C110117_0054_SCI',
               'C110124_0427_SCI',
               'C110124_0062_SCI',
               'C110124_0748_CAL',
               'C110124_0383_SCI',
               'C110117_0145_SCI',
               'C110124_0291_SCI',
               'C110117_0421_SCI',
               'C110124_0149_SCI',
               'C110124_0015_FOCUS',
               'C110117_0010_FOCUS',
               'C110117_0472_SCI',
               'C110117_0656_FOCUS',
               'C110124_0201_SCI',
               'C110117_0149_SCI',
               'C110124_0660_SCI',
               'C110124_0242_SCI',
               'C110124_0063_SCI',
               'C110117_0374_SCI',
               'C110117_0379_SCI',
               'C110124_0840_CAL',
               'C110124_0516_SCI',
               'C110124_0196_SCI',
               'C110117_0013_SCI',
               'C110124_0428_SCI',
               'C110124_0016_FOCUS',
               'C110117_0608_CAL',
               'C110117_0422_SCI',
               'C110117_0610_CAL',
               'C110124_0246_SCI',
               'C110117_0099_SCI',
               'C110117_0420_SCI',
               'C110124_0611_SCI',
               'C110124_0018_FOCUS',
               'C110117_0041_SCI',
               'C110124_0245_SCI',
               'C110117_0466_SCI',
               'C110124_0017_FOCUS',
               'C110117_0026_SCI',
               'C110124_0425_SCI',
               'C110124_0109_SCI',
               'C110117_0515_SCI',
               'C110117_0424_SCI',
               'C110117_0562_CAL',
               'C110124_0241_SCI',
               'C110124_0380_SCI',
               'C110124_0799_CAL',
               'C110117_0282_SCI',
               'C110124_0753_CAL',
               'C110124_0151_SCI',
               'C110117_0242_SCI',
               'C110117_0240_SCI',
               'C110124_0150_SCI',
               'C110117_0468_SCI',
               'C110117_0518_SCI',
               'C110117_0378_SCI',
               'C110124_0198_SCI',
               'C110124_0705_SCI',
               'C110124_0750_CAL',
               'C110117_0563_CAL',
               'C110124_0795_CAL',
               'C110124_0290_SCI',
               'C110117_0609_CAL',
               'C110124_0244_SCI',
               'C110124_0059_SCI',
               'C110117_0021_SCI',
               'C110117_0020_SCI',
               'C110117_0097_SCI',
               'C110117_0096_SCI',
               'C110124_0521_SCI',
               'C110117_0024_SCI',
               'C110124_0563_SCI',
               'C110117_0079_SCI',
               'C110117_0023_SCI',
               'C110117_0032_SCI',
               'C110124_0012_FOCUS',
               'C110117_0040_SCI',
               'C110124_0703_SCI',
               'C110124_0287_SCI',
               'C110117_0236_SCI',
               'C110117_0039_SCI',
               'C110124_0609_SCI',
               'C110124_0335_SCI',
               'C110124_0476_SCI',
               'C110117_0044_SCI',
               'C110117_0063_SCI',
               'C110117_0191_SCI',
               'C110124_0706_SCI',
               'C110117_0190_SCI',
               'C110117_0062_SCI',
               'C110124_0700_SCI',
               'C110117_0084_SCI',
               'C110124_0567_SCI',
               'C110124_0517_SCI',
               'C110117_0376_SCI',
               'C110117_0070_FOCUS',
               'C110124_0243_SCI',
               'C110124_0106_SCI',
               'C110124_0608_SCI',
               'C110117_0328_FOCUS',
               'C110117_0081_SCI',
               'C110117_0014_SCI',
               'C110124_0794_CAL',
               'C110124_0247_SCI',
               'C110117_0607_CAL',
               'C110117_0064_SCI',
               'C110117_0104_SCI',
               'C110124_0654_SCI',
               'C110117_0033_SCI',
               'C110117_0564_CAL',
               'C110124_0293_SCI',
               'C110117_0157_SCI',
               'C110124_0384_SCI',
               'C110117_0025_SCI',
               'C110117_0027_SCI',
               'C110117_0111_SCI',
               'C110117_0030_SCI',
               'C110117_0067_FOCUS',
               'C110124_0061_SCI',
               'C110124_0612_SCI',
               'C110124_0381_SCI',
               'C110117_0169_SCI',
               'C110124_0334_SCI',
               'C110124_0338_SCI',
               'C110117_0029_SCI',
               'C110124_0657_SCI',
               'C110124_0473_SCI',
               'C110124_0104_SCI',
               'C110117_0179_SCI',
               'C110124_0520_SCI',
               'C110117_0050_SCI',
               'C110124_0749_CAL',
               'C110117_0028_SCI',
               'C110124_0288_SCI',
               'C110124_0014_FOCUS',
               'C110117_0101_SCI'):
    meta_task = ToCaom2Operator(obs_id=obs_id,
                                root_dir=root_dir,
                                collection='OMM',
                                netrc=netrc,
                                task_id='{}_meta'.format(obs_id),
                                dag=dag)
    data_task = PreviewOperator(obs_id=obs_id,
                                root_dir=root_dir,
                                collection='OMM',
                                netrc=netrc,
                                task_id='{}_data'.format(obs_id),
                                dag=dag)
    data_task.set_upstream(meta_task)
